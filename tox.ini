[tox]
envlist =
    pre-commit
    stardag-py{311,312,313}
    stardag-pyright
    stardag-examples-py{311,312,313}
    stardag-examples-pyright
    stardag-api-py{311,312,313}
    stardag-api-pyright
    stardag-ui
    integration-tests-pyright

# ============================================================================
# lib/stardag - Core SDK
# ============================================================================
[testenv:stardag-py{311,312,313}]
description = Run tests for stardag package
skip_install = true
allowlist_externals = uv
change_dir = lib/stardag
commands_pre =
    uv sync --active --all-extras
commands =
    uv run --active pytest {posargs:tests}

[testenv:stardag-pyright]
description = Type check stardag package
skip_install = true
allowlist_externals = uv
change_dir = lib/stardag
commands_pre =
    uv sync --active --all-extras
commands =
    uv run --active pyright src tests

# ============================================================================
# lib/stardag-examples - Examples package
# ============================================================================
[testenv:stardag-examples-py{311,312,313}]
description = Run tests for stardag-examples package
skip_install = true
allowlist_externals = uv
change_dir = lib/stardag-examples
commands_pre =
    uv sync --active --all-extras
commands =
    uv run --active pytest {posargs:tests}

[testenv:stardag-examples-pyright]
description = Type check stardag-examples package
skip_install = true
allowlist_externals = uv
change_dir = lib/stardag-examples
commands_pre =
    uv sync --active --all-extras
commands =
    uv run --active pyright src tests

# ============================================================================
# app/stardag-api - API service
# ============================================================================
[testenv:stardag-api-py{311,312,313}]
description = Run tests for stardag-api package
skip_install = true
allowlist_externals = uv
change_dir = app/stardag-api
commands_pre =
    uv sync --active --all-extras
commands =
    uv run pytest {posargs:tests}

[testenv:stardag-api-pyright]
description = Type check stardag-api package
skip_install = true
allowlist_externals = uv
change_dir = app/stardag-api
commands_pre =
    uv sync --active --all-extras
commands =
    uv run --active pyright src tests

# ============================================================================
# app/stardag-ui - Frontend
# ============================================================================
[testenv:stardag-ui]
description = Run tests for stardag-ui frontend
skip_install = true
allowlist_externals = npm
change_dir = app/stardag-ui
commands_pre =
    npm install
commands =
    npm test

# ============================================================================
# Integration Tests (requires docker-compose services running)
# ============================================================================
[testenv:integration]
description = Run integration tests (requires docker-compose up)
skip_install = true
allowlist_externals = uv
basepython = python3.12
change_dir = integration-tests
passenv =
    STARDAG_API_URL
    KEYCLOAK_URL
    STARDAG_UI_URL
    STARDAG_DB_HOST
    STARDAG_DB_PORT
commands_pre =
    uv sync
commands =
    uv run pytest {posargs}

[testenv:integration-browser]
description = Run integration tests including browser tests (requires docker-compose up)
skip_install = true
allowlist_externals = uv
basepython = python3.12
change_dir = integration-tests
passenv =
    STARDAG_API_URL
    KEYCLOAK_URL
    STARDAG_UI_URL
    STARDAG_DB_HOST
    STARDAG_DB_PORT
commands_pre =
    uv sync --extra browser
    uv run playwright install chromium
commands =
    uv run pytest {posargs}

[testenv:integration-tests-pyright]
description = Type check integration tests
skip_install = true
allowlist_externals = uv
change_dir = integration-tests
commands_pre =
    uv sync --active --group dev --extra browser
commands =
    uv run --active pyright src tests

# ============================================================================
# Pre-commit (formatting/linting)
# ============================================================================
[testenv:pre-commit]
description = Run pre-commit hooks (formatting, linting)
skip_install = true
deps = pre-commit
# Skip pyright checks in pre-commit to avoid double type checking
# (they are run in their own tox envs)
setenv =
    SKIP = pyright-stardag,pyright-stardag-examples,pyright-stardag-api,pyright-integration-tests
commands = pre-commit run --all-files --show-diff-on-failure

# ============================================================================
# GitHub Actions mapping
# ============================================================================
[gh-actions]
# NOTE: pyright for stardag-api and integration-tests is only run for Python 3.12 in CI atm, to reduce total run time
python =
    3.11: stardag-py311, stardag-examples-py311, stardag-api-py311, stardag-pyright, stardag-examples-pyright
    3.12: stardag-py312, stardag-examples-py312, stardag-api-py312, stardag-pyright, stardag-examples-pyright, stardag-api-pyright, integration-tests-pyright
    3.13: stardag-py313, stardag-examples-py313, stardag-api-py313, stardag-pyright, stardag-examples-pyright
