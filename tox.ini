[tox]
envlist =
    pre-commit
    stardag-py{311,312,313}
    stardag-pyright
    stardag-examples-py{311,312,313}
    stardag-examples-pyright
    stardag-api-py{311,312,313}
    stardag-api-pyright
    stardag-ui

# ============================================================================
# lib/stardag - Core SDK
# ============================================================================
[testenv:stardag-py{311,312,313}]
description = Run tests for stardag package
skip_install = true
allowlist_externals = uv
change_dir = lib/stardag
commands_pre =
    uv sync --active --all-extras
commands =
    uv run --active pytest {posargs:tests}

[testenv:stardag-pyright]
description = Type check stardag package
skip_install = true
allowlist_externals = uv
change_dir = lib/stardag
commands_pre =
    uv sync --active --all-extras
commands =
    uv run --active pyright src tests

# ============================================================================
# lib/stardag-examples - Examples package
# ============================================================================
[testenv:stardag-examples-py{311,312,313}]
description = Run tests for stardag-examples package
skip_install = true
allowlist_externals = uv
change_dir = lib/stardag-examples
commands_pre =
    uv sync --active--all-extras
commands =
    uv run --active pytest {posargs:tests}

[testenv:stardag-examples-pyright]
description = Type check stardag-examples package
skip_install = true
allowlist_externals = uv
change_dir = lib/stardag-examples
commands_pre =
    uv sync --active --all-extras
commands =
    uv run --active pyright src tests

# ============================================================================
# app/stardag-api - API service
# ============================================================================
[testenv:stardag-api-py{311,312,313}]
description = Run tests for stardag-api package
skip_install = true
allowlist_externals = uv
change_dir = app/stardag-api
commands_pre =
    uv sync --active --all-extras
commands =
    uv run pytest {posargs:tests}

[testenv:stardag-api-pyright]
description = Type check stardag-api package
skip_install = true
allowlist_externals = uv
change_dir = app/stardag-api
commands_pre =
    uv sync --active --all-extras
commands =
    uv run --active pyright src tests

# ============================================================================
# app/stardag-ui - Frontend
# ============================================================================
[testenv:stardag-ui]
description = Run tests for stardag-ui frontend
skip_install = true
allowlist_externals = npm
change_dir = app/stardag-ui
commands_pre =
    npm install
commands =
    npm test

# ============================================================================
# Pre-commit (formatting/linting)
# ============================================================================
[testenv:pre-commit]
description = Run pre-commit hooks (formatting, linting)
skip_install = true
deps = pre-commit
# Skip pyright checks in pre-commit to avoid double type checking
# (they are run in their own tox envs)
setenv =
    SKIP = pyright-stardag,pyright-stardag-examples,pyright-stardag-api
commands = pre-commit run --all-files --show-diff-on-failure

# ============================================================================
# GitHub Actions mapping
# ============================================================================
[gh-actions]
# NOTE: pyright envs excluded until pre-existing type errors are fixed
# Run pyright locally with: tox -e stardag-pyright,stardag-examples-pyright,stardag-api-pyright
python =
    3.11: stardag-py311, stardag-examples-py311, stardag-api-py311
    3.12: stardag-py312, stardag-examples-py312, stardag-api-py312
    3.13: stardag-py313, stardag-examples-py313, stardag-api-py313
